name: Monthly builds

on:
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  snap:
    runs-on: [ubuntu-latest]
    env:
      SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT7_CREDS }}
      # snapcraft remote-build will create a repository with the name decided by the --build-id arg
      # URL to this repo echoed below to help debug builds (does not change if the workflow is re-run)
      SNAPCRAFT_BUILDER_ID: ${{ matrix.releases }}-${{ matrix.arch }}-${{ github.run_id }}
    name: Runtime (Core) ${{ matrix.releases }}-${{ matrix.arch }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Add LP credentials
        run: |
          mkdir -p ~/.local/share/snapcraft/provider/launchpad/
          echo '${{ secrets.LP_CREDS }}' > ~/.local/share/snapcraft/provider/launchpad/credentials
          git config --global user.email "canonical-robotics-brand@canonical.com"
          git config --global user.name "Canonical robotics"

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10' 
      - run: |
          pip install .
          python3 ./generate_all_ros_meta_snapcraft_file.py
      # - name: Print Launchpad build repository
      #   run: |
      #     echo "Building at: https://git.launchpad.net/~ce-certification-qa/+snap/$SNAPCRAFT_BUILDER_ID"
      - uses: snapcore/action-build@v1
        with:
          path: snaps/foxy_ros_base
          snapcraft-args: "--remote-build --launchpad-accept-public-upload --build-id foxy-ros-base-${SNAPCRAFT_BUILDER_ID}"
      - uses: actions/upload-artifact@v3
        name: Upload the snap as artifact
        with:
          name: remote-built snaps
          path: snaps/**/*.snap
